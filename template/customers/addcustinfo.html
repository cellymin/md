<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>苗博士_添加消费</title>
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="{$Think.const.STATIC_URL}lib/bootstrap/css/bootstrap.css">
    <link rel="stylesheet" href="{$Think.const.STATIC_URL}lib/font-awesome/css/font-awesome.css">
    <script src="{$Think.const.STATIC_URL}lib/jquery-1.11.1.min.js" type="text/javascript"></script>
    <link rel="stylesheet" type="text/css" href="{$Think.const.CSS_URL}theme.css">
    <link rel="stylesheet" type="text/css" href="{$Think.const.CSS_URL}premium.css">
    <script src="{$Think.const.STATIC_URL}layer/layer.js"></script>

    <script src="{$Think.const.STATIC_URL}plugins/cover_js/iscroll-zoom.js" type="text/javascript"
            charset="utf-8"></script>
    <script src="{$Think.const.STATIC_URL}plugins/cover_js/hammer.js" type="text/javascript" charset="utf-8"></script>
    <script src="{$Think.const.STATIC_URL}plugins/cover_js/lrz.all.bundle.js" type="text/javascript"
            charset="utf-8"></script>
    <script src="{$Think.const.STATIC_URL}plugins/cover_js/jquery.photoClip.min.js" type="text/javascript"
            charset="utf-8"></script>
    <link rel="stylesheet" type="text/css" href="{$Think.const.CSS_URL}commonedit.css">

</head>
<body class="theme-blue" style="">
<!-- Demo page code -->

<script type="text/javascript">
    $(function () {
        var match = document.cookie.match(new RegExp('color=([^;]+)'));
        if (match) var color = match[1];
        if (color) {
            $('body').removeClass(function (index, css) {
                return (css.match(/\btheme-\S+/g) || []).join(' ')
            })
            $('body').addClass('theme-' + color);
        }

        $('[data-popover="true"]').popover({html: true});

    });
</script>

<script type="text/javascript">
    $(function () {
        var uls = $('.sidebar-nav > ul > *').clone();
        uls.addClass('visible-xs');
        $('#main-menu').append(uls.clone());
    });
</script>

<!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
<!--[if lt IE 9]>
<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
<![endif]-->

<!-- Le fav and touch icons -->


<!--[if lt IE 7 ]>
<body class="ie ie6"> <![endif]-->
<!--[if IE 7 ]>
<body class="ie ie7 "> <![endif]-->
<!--[if IE 8 ]>
<body class="ie ie8 "> <![endif]-->
<!--[if IE 9 ]>
<body class="ie ie9 "> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!-->

<!--<![endif]-->
<!---->
{include file="template/sidebar.html"}
<div class="content">
    {include file="template/navbar.html"}
    <div>
        <span style="font-size: 18px;color: #22466f;">
            客户信息
        </span>
    </div>
    <div class="" id="ddd">
        <div class="modal-body">
            <form>
                <div class="form-group">
                    <div class="left_form">
                        <label>名称：</label>
                        <input type="hidden" class="userid" value="{$custinfo.id ?? ''}" >
                        <input type="text" class="user_name" value="{$custinfo.name ?? ''}" placeholder="请输入姓名">
                    </div>
                    <div class="right_form">
                        <label>门店：</label>

                        {if condition="($usign==2)"}
                        <input class="chain_input" type="text" value="{$cin.cname}" sid="{$cin.cid}" readonly>
                        {/if}
                        {if condition="($usign==1)"}
                        <select style="width: 75%;height:30px;" class="chain_id" name="chain_id"
                                autocomplete="off"
                                onchange="changechain(this)">

                            <option value="0" dd="" es="" ss="" taxrate="">请选择门店</option>
                            {foreach $chain as $k }
                            <option value="{$k.id}" dd="" es="" ss="{$k.id}" {if condition="(isset($custinfo) && $custinfo.chain_id==$k.id)"}selected="selected"{/if} taxrate="">{$k.name}</option>
                            {/foreach}
                        </select>
                        {/if}

                    </div>
                </div>
                <div class="form-group">
                    <div class="left_form">
                        <label><span>生日：</span></label>
                        <span id="date"><input type="text" class="user_birth" value="{$custinfo.birth ?? ''}"
                                               placeholder="请输入生日" id="inputdate" autocomplete="off"></span>
                    </div>
                    <div class="right_form user_sex">
                        <label><span>性别：</span></label>
                        <label class="user_sex_la"><input style="width: 20px;height: 11px;" type="radio" name="sex" {if
                                                          condition="(isset($custinfo) && $custinfo.sex == 1)" }checked
                                                          {/if} value="1">男
                            <input style="width: 20px;height: 11px;" type="radio" name="sex" {if
                                   condition="(isset($custinfo) && $custinfo.sex == 2)" }checked {/if}
                            value="2">女</label>
                    </div>

                </div>
                <div class="form-group">
                    <div class="left_form">
                        <label>电话：</label>
                        <input type="text" class="user_phone" value="{$custinfo.phone ?? ''}" placeholder="请输入电话"
                               onchange="if_unique(this);">
                    </div>
                    <div class="right_form">
                        <label>邮箱：</label>
                        <input type="text" class="user_email" value="{$custinfo.email ?? ''}" placeholder="请输入邮箱">
                    </div>
                </div>
                <div class="form-group">
                    <label>地址：</label>
                    <input style="width: 60%" type="text" class="user_address" value="{$custinfo.address ?? ''}" placeholder="请输入地址">
                </div>
                <div class="form-group">
                    <label>来源：</label>
                    <select style="width: 36%" name="source_from" class="source_from">
                        <option value="0">请选择来源</option>
                        {foreach $source as $k }
                        <option value="{$k.fromway_id}" {if
                                condition="(isset($custinfo) && $custinfo.source_id == $k.fromway_id)" }selected="selected" {/if}>{$k.fromway_name}</option>
                        {/foreach}
                    </select>

                </div>
            </form>
        </div>
        <div style="margin-top: 8px;">
        <span style="font-size: 18px;color: #22466f;">
            消费信息
        </span>
        </div>
        <div class="modal-body">
            <div class="form-group">

                <label>是否本店支付：</label>
                <label class="user_sex_la"><input style="width: 20px;height: 11px;" type="radio" name="if_local"
                                                  value="1" checked
                                                  onchange="iflocal(this)">是
                    <input style="width: 20px;height: 11px;" type="radio" type="radio" name="if_local" value="2"
                           onchange="iflocal(this)">否
                </label>

            </div>
            <div class="form-group">
                <div class="left_form serchainid">
                    <label>服务门店：</label>
                    <input style="width: 69%" class="serchain_input" type="text" value="{$cin.cname ?? ''}" sid="{$cin.cid ?? ''}" readonly>
                </div>
                <div class="right_form xiaofeichain" style="display: none">
                    <label>消费门店：</em> </label>

                    <select style="width: 69%;height:30px;"
                            class="xfchain_select" name="xfchain_id" autocomplete="off">
                        <option value="0" dd="" es="" ss="" taxrate="">请选择消费门店</option>
                        {foreach $chain as $k }
                        <option value="{$k.id}" dd="" es="" ss="{$k.id}" taxrate="">{$k.name}</option>
                        {/foreach}
                    </select>
                </div>
            </div>
            <div class="form-group">
                <div class="left_form tcxz">
                    <label>诊疗项目：</label>
                    <select style="width: 69%;height:30px;" class="packageselect" name="wz_detail" autocomplete="off" onclick="if_tuifei(this)">
                        {foreach $package as $k }
                        <option value="{$k.package_id}" dd="" es="" ss="{$k.package_id}"
                                taxrate="">{$k.package_name}</option>
                        {/foreach}
                        <option value="-1" dd="" es="" ss="">退款</option>
                    </select>
                    </span>
                    <div class="project c" style="display: none">

                    </div>
                </div>
                <div class="right_form">

                </div>
            </div>
            <div class="form-group">
                <div class="left_form jishi">
                    <label style="letter-spacing: 4px;">治疗师：</label>
                    <select style="width: 69%;height:30px;" class="jishiselect" name="jishi" autocomplete="off">
                        {foreach $jishi as $k }
                        <option value="{$k.id}" dd="" es="" ss="{$k.id}" taxrate="">{$k.name}</option>
                        {/foreach}
                    </select>
                </div>
                <div class="right_form qiantai">
                    <label>前台接待：</label>
                    <select style="width: 69%;height:30px;" class="qiqantaiselect" name="reception"
                            autocomplete="off">
                        {foreach $reception as $k }
                        <option value="{$k.id}" dd="" es="" ss="{$k.id}" taxrate="">{$k.name}</option>
                        {/foreach}
                    </select>
                </div>
            </div>
            <div class="form-group">
                <div class="left_form">
                    <label style="letter-spacing: 4px;">卡划扣：</label>
                    <input style="width: 69%;" class="huakou" type="text" value=""/>
                </div>
                <div class="right_form">
                    <label>现有余额：</label>
                    <input  class="charge_money" type="text" value="{$custinfo.money ?? ''}"  {if condition="(isset($cardinfo) && !empty($cardinfo))"}  readonly style='width: 69%;background: #ccc'{else/}style='width: 69%;' {/if} />
                </div>

            </div>
            <div class="form-group">
                <div class="left_form fangshi">
                    <label>支付方式：</label>
                    <select style="width: 69%;height:30px;" class="payway" name="wz_detail" autocomplete="off">
                        {foreach $payway as $k }
                        <option value="{$k.payway_id}" dd="" es="" ss="{$k.payway_id}"
                                taxrate="">{$k.payway_name}
                        </option>
                        {/foreach}
                    </select>
                </div>
                <div class="right_form">
                    <label>消费金额：</label>
                    <input style="width: 69%;" class="money_total" type="text" value=""/>
                </div>
            </div>
            <div class="form-group">
                <div class="left_form">
                    <label>是否结清：</label>
                    <label><input style="width: 20px;height: 11px;" type="radio" name="if_owe" value="1" checked
                                  onchange="ifowe(this)">&nbsp;是&nbsp;
                        <input style="width: 20px;height: 11px;" type="radio" name="if_owe" value="2"
                               onchange="ifowe(this)">&nbsp;否
                    </label>
                </div>
                <div class="right_form owemoney" style="display: none">
                    <label>欠款金额：</label>
                    <input class="owe_money" type="text" value="" sid=""/>
                </div>
            </div>
            <div class="form-group">
                <div class="left_form">
                    <label>备注：</label>
                    <textarea
                            style="border:1px solid #ccc;border-radius:5px;background-color:rgba(241,241,241,.98);width: 26rem;height: 100px;padding: 10px;resize: none;font-size: 14px"
                            placeholder="消费备注" class="xfbeizhu">

                   </textarea>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-footer" style="margin-bottom: 20px; text-align: center;">
        <div class="cancle_btn" >
            <button onclick="close_open();">取消</button>
        </div>
        <div class="confim_btn" >
            <button attrid="{$userinfo.id ?? ''}" onclick="confirmsub(this);">保存</button>
        </div>
    </div>

</div>
</div>
<div class="layui-layer-shade" style="z-index:19891019; background:url(); display:none;" id="xiugaiyynn">
    <div class="layui-layer layui-anim layui-layer-page layer-ext-moon"
         style="z-index: 19891020; width:310px; height:250px; left:50%; margin-left:-155px;">
        <div class="layui-layer-title" style="cursor: move;">选择项目</div>
        <div class="layui-layer-content">
            <div class="animated">
                <!--                <form action="__URL__/managexf" method="post" class="form-horizontal">-->
                <div class="ibox float-e-margins" style="margin-bottom:0px;">
                    <div class="ibox-content">
                        <div class="input-group m-b" style="margin-bottom:5px;">
                            <div class="demochk">
                                <span>项目一</span><input type="checkbox" name="demo[]" class="ck_1" value="1">
                            </div>
                            <div class="demochk">
                                <span>项目二</span><input type="checkbox" name="demo[]" class="ck_2" value="2">
                            </div>
                            <div class="demochk">
                                <span>项目三</span><input type="checkbox" name="demo[]" class="ck_3" value="3">
                            </div>
                            <div class="demochk">
                                <span>项目四</span><input type="checkbox" name="demo[]" class="ck_4" value="4">
                            </div>
                            <div class="demochk">
                                <span>项目五</span><input type="checkbox" name="demo[]" class="ck_5" value="5">
                            </div>
                            <div class="demochk">
                                <span>项目六</span><input type="checkbox" name="demo[]" class="ck_6" value="6">
                            </div>
                            <div class="demochk">
                                <span>项目七</span><input type="checkbox" name="demo[]" class="ck_7" value="7">
                            </div>
                            <div class="demochk">
                                <span>项目八</span><input type="checkbox" name="demo[]" class="ck_8" value="8">
                            </div>
                            <div class="demochk">
                                <span>项目九</span><input type="checkbox" name="demo[]" class="ck_9" value="9">
                            </div>
                            <div class="demochk">
                                <span>项目十</span><input type="checkbox" name="demo[]" class="ck_10" value="10">
                            </div>
                            <div class="demochk">
                                <span>项目十一</span><input type="checkbox" name="demo[]" class="ck_11" value="11">
                            </div>


                        </div>
                        <div class="form-group" align="center" style="margin-bottom:5px;">
                            <p style="background: #29b578; width: 9rem; height: 3rem; line-height: 3rem; color: #fff;  letter-spacing: 1px;margin-top: 1rem;">
                                <sapn style="cursor: pointer;" onclick="confirmpro();">确定</sapn>
                            </p>
                        </div>
                    </div>
                </div>
                <!--                </form>-->
            </div>
        </div>
        <span class="layui-layer-setwin" id="xiugaiyyxx"><a class="layui-layer-ico layui-layer-close layui-layer-close1"
                                                            href="javascript:;"></a></span>
    </div>
</div>
{include file="template/footer.html"}
<script>
    $('#xiugaiyyxx').on('click', function () {
        $('#xiugaiyynn').hide()
    });
    function if_tuifei(e) {
        var pkid = parseInt($(e).val());
        if(pkid==-1){
            $('.huakou').val('');
            $('.huakou').attr('readonly','readonly');
            $('.huakou').css('background','#ccc');
            $('.charge_money').attr('readonly','readonly');
            $('.charge_money').css('background','#ccc');
        }else{
            $('.huakou').removeAttr('readonly');
            $('.huakou').css('background','');
            $('.charge_money').removeAttr('readonly');
            $('.charge_money').css('background','');
        }
    }
    function changechain(e) {
        var chainid = parseInt($(e).val());
        $('.serchain_select').remove();
        $('.serchain_input').remove();
        $('.jishiselect').remove();
        $('.qiqantaiselect').remove();
        $('.packageselect').remove();
        var chainname = $(e).find("option:selected").text();
        //mendian serchainid
         var ch = '  <input style="width: 69%" class="serchain_input" type="text" value="'+chainname+'" sid="'+chainid+'" readonly>'

        //jishi jishiselect
        var js = '<select style="width: 69%;height:25px;" class="jishiselect" name="jishi" autocomplete="off">';
        //qiantai qiantaiselect
        var pk = '<select style="width: 69%;height:25px;" class="packageselect" name="reception" autocomplete="off">';
        //tcxz packageselect
        var cp = '<select style="width: 69%;height:25px;" class="qiqantaiselect" name="wz_detail" autocomplete="off" >';
        $.ajax({
            url: '{$Think.const.DQURL}index/customers/changechain',// 获取自己系统后台用户信息接口
            data: {'chainid': chainid},
            type: "POST",
            dataType: "json",
            success: function (data) {
                if (data) {
                    var data = JSON.parse(data);
                    // console.log(data);return  false;
                    if (data.code == "200") { //判断返回值，这里根据的业务内容可做调整
                        var jishi = data.jishi;
                        for (var i in jishi) {
                            js += '  <option value="' + jishi[i]['id'] + '" dd="" es="" ss="' + jishi[i]['id'] + '" taxrate="">' + jishi[i]['name'] + '</option>'
                        }
                        js += '</select>';
                        $('.jishi').append(js);

                        var reception = data.reception;
                        for (var i in reception) {
                            cp += '  <option value="' + reception[i]['id'] + '" dd="" es="" ss="' + reception[i]['id'] + '" taxrate="">' + reception[i]['name'] + '</option>'
                        }
                        cp += '</select>';
                        $('.qiantai').append(cp);

                        var package = data.package;
                        for (var i in package) {
                            pk += '  <option value="' + package[i]['package_id'] + '" dd="" es="" ss="' + package[i]['package_id'] + '" taxrate="">' + package[i]['package_name'] + '</option>'
                        }
                        pk += '   <option value="-1" dd="" es="" ss="" >退款</option></select>';
                        $('.tcxz').append(pk);
                        $('.serchainid').append(ch);


                    } else {
                        alert(data.msg);
                        return false;
                    }
                }
            },
            error: function (data) {
                $(e).removeAttr('disabled');
                console.log(data.message);
            }
        });
    }

    function deldd(e) {
        $(e).parent().parent().remove();
    }

    function confirmpro() {
        ss = ''
        $("input[name='demo[]']:checked").each(function () {
            var id = parseInt($(this).val());
            var con = $(this).parent().text();
            ss += '<p did="' + id + '"><span>' + con + '<i onclick="deldd(this);">x</i></span></p>'
        });
        $('.project').html('');
        $('.project').html(ss);
        $('#xiugaiyynn').hide()


    }

    function xzxm() {
        var dids = new Array();
        var did = 0;
        $(".project p").each(function () {
            did = parseInt($(this).attr('did'));
            if (did > 0) {
                dids.push(did);
            }
        });
        $('.demochk').each(function () {
            var xzdid = parseInt($(this).find("input[name='demo[]']").val());
            if ($.inArray(xzdid, dids) != -1) {
                $(this).find("input[name='demo[]']").attr("checked", true);
            }

        })

        $('#xiugaiyynn').show();

    }

    function iflocal(e) {
        var iflocal = parseInt($(e).val());
        if (iflocal == 1) {
            //本店支付
            $('.xiaofeichain').css('display', 'none');

        } else if (iflocal == 2) {
            $('.xiaofeichain').css('display', '');
        }
        var ss = ' <select style="width: 69%;height:25px;" class="payway" name="wz_detail" autocomplete="off">';
        $('.payway').remove();
        //借店支付
        $.ajax({
            url: '{$Think.const.DQURL}index/customers/payway',// 获取自己系统后台用户信息接口
            data: {'type': iflocal},
            type: "POST",
            dataType: "json",
            success: function (data) {
                if (data) {
                    var data = JSON.parse(data);
                    // console.log(data);return  false;
                    if (data.code == "200") { //判断返回值，这里根据的业务内容可做调整
                        var payway = data.payway;
                        for (var i in payway) {
                            ss += '  <option value="' + payway[i]['payway_id'] + '" dd="" es="" ss="' + payway[i]['payway_id'] + '" taxrate="">' + payway[i]['payway_name'] + '</option>'
                        }
                        ss += '</select>';
                        $('.fangshi').append(ss);
                    } else {
                        alert(data.msg);
                        return false;
                    }
                }
            },
            error: function (data) {
                $(e).removeAttr('disabled');
                console.log(data.message);
            }
        });
    }

    function ifowe(e) {
        var owe = parseInt($(e).val());
        if (owe == 1) {
            $(e).parent().parent().parent().find('.owemoney').css('display', 'none');
        } else if (owe == 2) {
            $(e).parent().parent().parent().find('.owemoney').css('display', '');
        }
    }
    function if_unique(e) {
        var phone = $(e).val();
        $.ajax({
            url: '{$Think.const.DQURL}index/customers/if_exist',// 获取自己系统后台用户信息接口
            data: {"phone": phone},
            type: "POST",
            dataType: "json",
            success: function (data) {
                if (data) {
                    var data = JSON.parse(data);
                    if (data.code == "200") { //判断返回值，这里根据的业务内容可做调整
                    } else {
                        layer.msg(data.msg);
                        $(e).val('');
                        $(e).focus();
                        return false;
                    }
                }
            },
            error: function (data) {
                $(e).removeAttr('disabled');
                console.log(data.message);
            }
        });
    }

    function ifpak(e) {
        var iftc = parseInt($(e).val());
        if (iftc == 1) {
            //选择套餐
            $('.xmxz').css('display', 'none');
            $('.tcxz').css('display', '');
            $('.project').css('display', 'none');
        } else if (iftc == 2) {
            //选择项目
            $('.xmxz').css('display', '');
            $('.project').css('display', '');
            $('.tcxz').css('display', 'none');
        }
    }

    function confirmsub(e) {
        $(e).attr('disabled','disabled');
        var user_info = '';
        var user_name = $('.user_name').val().replace(/(^\s*)|(\s*$)/g, "");
        var user_birth = $('.user_birth').val().replace(/(^\s*)|(\s*$)/g, "");
        var user_phone = $('.user_phone').val().replace(/(^\s*)|(\s*$)/g, "");
        var user_email = $('.user_email').val().replace(/(^\s*)|(\s*$)/g, "");
        var user_address = $('.user_address').val().replace(/(^\s*)|(\s*$)/g, "");
        var source_id = parseInt($('.source_from').val());
        var source_from = $('.source_from').find("option:selected").text().replace(/(^\s*)|(\s*$)/g, "");
        var user_sex = parseInt($('input[name="sex"]:checked').val());
        var chain_id =  $('.chain_id').find("option:selected").val();
        if(chain_id!=undefined && chain_id!=null && chain_id!=''){
            chain_id = chain_id.replace(/(^\s*)|(\s*$)/g, "");
        }else{
            chain_id = $('.chain_input').attr('sid');
        }
        var charge_money = Number($('.charge_money').val());
        if(!(/^1[3456789]\d{9}$/.test(user_phone))){
            layer.msg("手机号码有误，请重填");
            $(e).removeAttr('disabled');
            return false;
        }
        if(!(parseInt(chain_id)>0)){
            layer.msg('门店不能为空请选择');
            $(e).removeAttr('disabled');
            return false;
        }
        user_info = 'username*' + user_name + ','
            + ',userbirth*' + user_birth
            + ',sex*' + user_sex
            + ',userphone*' + user_phone
            + ',useremail*' + user_email
            + ',useraddress*' + user_address
            + ',sourceid*' + source_id
            + ',sourcefrom*' + source_from
            + ',money*' + charge_money //没有卡的时候卡充值金额
            + ',chainid*' + chain_id;

        var xfinfo = '';
        var jishiid = parseInt($('.jishiselect').val());
        var jishiname = $('.jishiselect').find("option:selected").text();
        var receptionid = parseInt($('.qiqantaiselect').val());
        var serchainid;
        var paywayid = $('.payway').val();
        var moneytotal = $('.money_total').val();
        var huakou = $('.huakou').val();


        var xfbeizhu = $('.xfbeizhu').val();
        var owemoney;
        var packageid = parseInt($('.packageselect').val());

        //非1权限选择
        var norchainid = parseInt($('.chain_input').attr('sid'));

        //1权限选择
        var supchainid = parseInt($('.serchain_input').attr('sid'));

        if (norchainid > 0) {
            serchainid = norchainid;
        }

        if (supchainid > 0) {
            serchainid = supchainid;
        }
        var xfchainid = parseInt($('.xfchain_select').val());
        var iflocal = parseInt($("input[name='if_local']:checked").val());
        var clean = parseInt($("input[name='if_owe']:checked").val());
        if(Number(moneytotal)>0 || Number(huakou)>0){
            if (!(serchainid > 0)) {
                layer.msg("请选择服务门店");
                $(e).removeAttr('disabled');
                return false;
            }
            if (!(jishiid > 0)) {
                layer.msg('请选择治疗师');
                $(e).removeAttr('disabled');
                return false;
            }

            if (iflocal == 2) {
                //借店支付
                if (!(xfchainid > 0)) {
                    layer.msg("请选择消费门店");
                    $(e).removeAttr('disabled');
                    return false;
                }
            }
            var regu = /^[0-9]+\.?[0-9]*$/;
            if (moneytotal != "") {
                if (!regu.test(moneytotal)) {
                    layer.msg("请输入正确的金额");
                    $('.money_total').val('');
                    $('.money_total').focus();
                    $(e).removeAttr('disabled');
                    return false;
                }
            } else {
                layer.msg("请输入消费金额")
                $(e).removeAttr('disabled');
                return false;
            }
            if (huakou != "") {
                if (!regu.test(moneytotal)) {
                    layer.msg("请输入正确的划扣金额");
                    $('.huakou').val('');
                    $('.huakou').focus();
                    $(e).removeAttr('disabled');
                    return false;
                }else if(charge_money-Number(huakou)<0){
                    //划扣金额小于充值金额
                    layer.msg("划扣金额不能大于充值金额");
                    $(e).removeAttr('disabled');
                    return false;
                }
            }
            if (clean == 1) {
                owemoney = 0;
            } else if (clean == 2) {
                owemoney = $('.owe_money').val();
                if (!regu.test(owemoney)) {
                    layer.msg("请输入正确的欠费金额");
                    $(e).removeAttr('disabled');
                    return false;
                }
            }
        }

        xfinfo += 'jishi_id*' + jishiid + ',';
        xfinfo += 'jishi_name*' + jishiname + ',';
        xfinfo += 'reception_id*' + receptionid + ',';
        xfinfo += 'if_local*' + iflocal + ',';
        if (iflocal == 1) {
            xfinfo += 'serchain_id*' + serchainid + ',';
            xfinfo += 'xfchain_id*' + serchainid + ',';
        } else if (iflocal == 2) {
            xfinfo += 'serchain_id*' + serchainid + ',';
            xfinfo += 'xfchain_id*' + xfchainid + ',';
        }
        xfinfo += 'total_money*' + moneytotal + ',';
        xfinfo += 'huakou*' + huakou + ',';
        xfinfo += 'xfbeizhu*' + xfbeizhu + ',';
        xfinfo += 'payway_id*' + paywayid + ',';
        xfinfo += 'clean*' + clean + ',';
        xfinfo += 'owe*' + owemoney + ',';
        xfinfo += 'package_id*' + packageid + ',';

        var custid = Number($('.userid').val());
        if(parseInt(custid)>0){
            var uri = '{$Think.const.DQURL}index/customers/savecustxf?id='+custid;
        }else{
            var uri = '{$Think.const.DQURL}index/customers/savecustxf';
        }
        $.ajax({
            url: uri,// 获取自己系统后台用户信息接口
            data: {'xfinfo': xfinfo,'user_info':user_info},
            type: "POST",
            dataType: "json",
            success: function (data) {
                if (data) {
                    var data = JSON.parse(data);
                    // console.log(data);return  false;
                    if (data.code == "200") { //判断返回值，这里根据的业务内容可做调整
                        layer.msg(data.msg);
                        window.location.href='{$Think.const.DQURL}index/customers/detailinfo?id='+data.custid;
                    } else {
                        $(e).removeAttr('disabled');
                        layer.msg(data.msg);
                        return false;
                    }
                }
            },
            error: function (data) {
                $(e).removeAttr('disabled');
                console.log(data.message);
            }
        });
    }
    function close_open() {
          window.location.reload();
    }


</script>
</body>
</html>