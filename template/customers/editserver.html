<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>苗博士_增加客户资料</title>
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="{$Think.const.STATIC_URL}lib/bootstrap/css/bootstrap.css">
    <link rel="stylesheet" href="{$Think.const.STATIC_URL}lib/font-awesome/css/font-awesome.css">
    <script src="{$Think.const.STATIC_URL}lib/jquery-1.11.1.min.js" type="text/javascript"></script>
    <link rel="stylesheet" type="text/css" href="{$Think.const.CSS_URL}theme.css">
    <link rel="stylesheet" type="text/css" href="{$Think.const.CSS_URL}premium.css">
    <script src="{$Think.const.STATIC_URL}layer/layer.js"></script>
    <script src="{$Think.const.STATIC_URL}plugins/cover_js/iscroll-zoom.js" type="text/javascript" charset="utf-8"></script>
    <script src="{$Think.const.STATIC_URL}plugins/cover_js/hammer.js" type="text/javascript" charset="utf-8"></script>
    <script src="{$Think.const.STATIC_URL}plugins/cover_js/lrz.all.bundle.js" type="text/javascript" charset="utf-8"></script>
    <script src="{$Think.const.STATIC_URL}plugins/cover_js/jquery.photoClip.min.js" type="text/javascript"
            charset="utf-8"></script>
    <link rel="stylesheet" type="text/css" href="{$Think.const.CSS_URL}server.css">
</head>
<style>
</style>
<body>
{include file="template/sidebar.html"}
<div class="content" id="" style="">
    {include file="template/navbar.html"}
    <div class="base_base mbs_header">
        <!--        <p class="mbs_title">祛斑跟踪表</p>-->
        <p class="mbs_no" attruid="{$serinfo.cusid}" attrid="{$serid}" >
            编号：<span>{$serinfo.server_no}</span>
        </p>
    </div>
    <div class="base_base base_info">
        <p>一、基本资料</p>
        <div class="base_left">
            <span><em>姓名：</em>{$serinfo.customer_name}</span>
            <span><em>性别：</em>
                {if condition="(isset($serinfo) && $serinfo.sex == 1)" }男
                       {elseif condition="$serinfo.sex == 2"/} 女 {/if}  </span>
            <p>
             <span><em>出生日期：</em>
             {$serinfo.birth|substr=0,4}<em>年</em>
                 {$serinfo.birth|substr=5,2}<em>月</em>
                 {$serinfo.birth|substr=8,2}<em>日</em>
        </span>
            </p>
            <p class="base_phone">联系方式：{$serinfo.phone}</p>
            <p class="base_phone">联系地址：{$serinfo.address}</p>
            <span class="base_job">职业：<input type="text" name="user_job" id="user_job" value="{$serinfo.cusjob}" {if condition='$sign == 3' } readonly {/if}></p></span>
            <p><span class="if_marry">婚否：
                 <label><input type="radio" name="is_marry" value="1" {if condition="(isset($serinfo) && $serinfo.cusismarry == 1)" } checked {/if}   {if condition="$sign == 3" } onclick="return false;" {/if}>是 </label>
                <label><input type="radio" name="is_marry" value="2"  {if condition="(isset($serinfo) && $serinfo.cusismarry == 2)" } checked {/if}  {if condition="$sign == 3" } onclick="return false;" {/if}>否</label>
            </span>
            </p>
        </div>
        <div class="base_right">
            <div style="min-height:1px;position:relative;" ontouchstart="">
                <div class="cover-wrap" style="">
                    <div class="cece" style="">
                        <div id="clipArea" style=""></div>
                        <div class="cece_1" style="">
                            <button id="clipBtn" style="">保存封面</button>
                        </div>
                    </div>
                </div>
                    <div id="view" style="" title="请上传 198*172 的头像"></div>
                <div style="height:10px;"></div>
                <div class="cece_2" style="background-image: url('{$serinfo.srcsource}');background-size: 100%;">
                    <input type="file" id="file" style="">
                </div>
            </div>
        </div>
    </div>
    <div class="base_base base_info" style="height: 40px;clear:both;">
        <div class="add_div">
            <p>图片:  <span class="add choose">添加</span></p>

            <input type="file" name="" id="choose-file" multiple="multiple" style="opacity: 0;height: 0px"/>
            <ul class="file-list ">
                {foreach $picarr as $k}
                <li class="file-item"><img src="/upload/{$k.url}/{$k.name}" alt="" height="70"></li>
                {/foreach}
            </ul>
        </div>
    </div>
    <div class="base_base skin_des">
        <p>二、皮肤综合分析</p>
        <div class="pifu_base">
            <div class="pifu_left">
                <table class="fu_select">
                    <tr class="skin_cate">
                        <td class="skin_title">皮肤类型</td>
                        <td class="skin_select">
                            <label><input type="checkbox" name="skin_cate"  {if condition="$sign == 3" } onclick="return false;" {/if} {if condition="in_array('中性',$skin_cate)"} checked {/if} value="中性"><em>中性</em></label>
                            <label><input type="checkbox" name="skin_cate"  {if condition="$sign == 3" } onclick="return false;" {/if} {if condition="in_array('干性',$skin_cate)"} checked {/if}  value="干性"><em>干性</em></label>
                            <label><input type="checkbox" name="skin_cate"  {if condition="$sign == 3" } onclick="return false;" {/if} {if condition="in_array('油性',$skin_cate)"} checked {/if}  value="油性"><em>油性</em></label>
                            <label><input type="checkbox" name="skin_cate"  {if condition="$sign == 3" } onclick="return false;" {/if} {if condition="in_array('混合性',$skin_cate)"} checked {/if}  value="混合性"><em>混合性</em></label>
                            <label><input type="checkbox" name="skin_cate"  {if condition="$sign == 3" } onclick="return false;" {/if} {if condition="in_array('暗疮性',$skin_cate)"} checked {/if}  value="暗疮性"><em>暗疮性</em></label>
                            <label><input type="checkbox" name="skin_cate"  {if condition="$sign == 3" } onclick="return false;" {/if} {if condition="in_array('敏感性',$skin_cate)"} checked {/if}  value="敏感性"><em>敏感性</em></label>
                        </td>
                    </tr>
                    <tr class="health_info">
                        <td class="skin_title">身体情况</td>
                        <td class="skin_select">
                            <label><input type="checkbox" name="health_info"  {if condition="$sign == 3" } onclick="return false;" {/if} {if condition="in_array('高血压',$health)"} checked {/if} value="高血压"><em>高血压</em></label>
                            <label><input type="checkbox" name="health_info"  {if condition="$sign == 3" } onclick="return false;" {/if} {if condition="in_array('心脏病',$health)"} checked {/if} value="心脏病"><em>心脏病</em></label>
                            <label><input type="checkbox" name="health_info"  {if condition="$sign == 3" } onclick="return false;" {/if} {if condition="in_array('糖尿病',$health)"} checked {/if} value="糖尿病"><em>糖尿病</em></label>
                            <label><input type="checkbox" name="health_info"  {if condition="$sign == 3" } onclick="return false;" {/if} {if condition="in_array('疤痕体质',$health)"} checked {/if} value="疤痕体质"><em>疤痕体质</em></label>
                            <label><input type="checkbox" name="health_info"  {if condition="$sign == 3" } onclick="return false;" {/if} {if condition="in_array('白癜风',$health)"} checked {/if} value="白癜风"><em>白癜风</em></label>
                            <label><input type="checkbox" name="health_info"  {if condition="$sign == 3" } onclick="return false;" {/if} {if condition="in_array('妊娠期/哺乳期',$health)"} checked {/if} value="妊娠期/哺乳期"><em>妊娠期/哺乳期</em></label>
                            <label><input type="checkbox" name="health_info"  {if condition="$sign == 3" } onclick="return false;" {/if} {if condition="in_array('甲状腺功能亢进或低下',$health)"} checked {/if}  value="甲状腺功能亢进或低下" ><em>甲状腺功能亢进或低下</em></label>
                            <label><input type="checkbox" name="health_info"  {if condition="$sign == 3" } onclick="return false;" {/if} {if condition="in_array('肝肾功能疾病',$health)"} checked {/if} value="肝肾功能疾病"><em>肝肾功能疾病</em></label>
                        </td>
                    </tr>
                    <tr class="experience">
                        <td class="skin_title">祛斑经历</td>
                        <td class="skin_select">
                            <label><input type="checkbox" name="freckle_experience"  {if condition="$sign == 3" } onclick="return false;" {/if} {if condition="in_array('E 光',$freckle_experience)"} checked {/if} value="E&nbsp;光"><em>E&nbsp;光</em></label>
                            <label><input type="checkbox" name="freckle_experience"  {if condition="$sign == 3" } onclick="return false;" {/if} {if condition="in_array('彩光',$freckle_experience)"} checked {/if} value="彩光"><em>彩光</em></label>
                            <label><input type="checkbox" name="freckle_experience"  {if condition="$sign == 3" } onclick="return false;" {/if} {if condition="in_array('激光',$freckle_experience)"} checked {/if} value="激光"><em>激光</em></label>
                            <label><input type="checkbox" name="freckle_experience"  {if condition="$sign == 3" } onclick="return false;" {/if} {if condition="in_array('磁波',$freckle_experience)"} checked {/if} value="磁波"><em>磁波</em></label>
                            <label><input type="checkbox" name="freckle_experience"  {if condition="$sign == 3" } onclick="return false;" {/if} {if condition="in_array('液氮',$freckle_experience)"} checked {/if} value="液氮"><em>液氮</em></label>
                            <label><input type="checkbox" name="freckle_experience"  {if condition="$sign == 3" } onclick="return false;" {/if} {if condition="in_array('点斑水',$freckle_experience)"} checked {/if} value="点斑水"><em>点斑水</em></label>
                            <label><input type="checkbox" name="freckle_experience"  {if condition="$sign == 3" } onclick="return false;" {/if} {if condition="in_array('点刺/火针',$freckle_experience)"} checked {/if} value="点刺/火针"><em>点刺/火针</em></label>
                            <label><input type="checkbox" name="freckle_experience"  {if condition="$sign == 3" } onclick="return false;" {/if} {if condition="in_array('换肤',$freckle_experience)"} checked {/if} value="换肤"><em>换肤</em></label>
                            <label><input type="checkbox" name="freckle_experience"  {if condition="$sign == 3" } onclick="return false;" {/if} {if condition="in_array('外用祛斑霜',$freckle_experience)"} checked {/if} value="外用祛斑霜"><em>外用祛斑霜</em></label>
                        </td>
                    </tr>
                    <tr class="stain_type">
                        <td class="skin_title">色斑类型</td>
                        <td class="skin_select">
                            <label><input type="checkbox" name="stains_cate"  {if condition="$sign == 3" } onclick="return false;" {/if} {if condition="in_array('雀斑',$stains_cate)"} checked {/if} value="雀斑" ><em>雀斑</em></label>
                            <label><input type="checkbox" name="stains_cate"  {if condition="$sign == 3" } onclick="return false;" {/if} {if condition="in_array('黄褐斑',$stains_cate)"} checked {/if} value="黄褐斑" ><em>黄褐斑</em></label>
                            <label><input type="checkbox" name="stains_cate"  {if condition="$sign == 3" } onclick="return false;" {/if} {if condition="in_array('真皮斑',$stains_cate)"} checked {/if} value="真皮斑" ><em>真皮斑</em></label>
                            <label><input type="checkbox" name="stains_cate"  {if condition="$sign == 3" } onclick="return false;" {/if} {if condition="in_array('老年斑',$stains_cate)"} checked {/if} value="老年斑" ><em>老年斑</em></label>
                            <label><input type="checkbox" name="stains_cate"  {if condition="$sign == 3" } onclick="return false;" {/if} {if condition="in_array('黑痣',$stains_cate)"} checked {/if} value="黑痣" ><em>黑痣</em></label>
                            <label><input type="checkbox" name="stains_cate"  {if condition="$sign == 3" } onclick="return false;" {/if} {if condition="in_array('粉刺',$stains_cate)"} checked {/if}  value="粉刺" ><em>粉刺</em></label>
                            <label><input type="checkbox" name="stains_cate"  {if condition="$sign == 3" } onclick="return false;" {/if} {if condition="in_array('痤疮',$stains_cate)"} checked {/if} value="痤疮" ><em>痤疮</em></label>
                            <label><input type="checkbox" name="stains_cate"  {if condition="$sign == 3" } onclick="return false;" {/if} {if condition="in_array('汗管瘤',$stains_cate)"} checked {/if} value="汗管瘤" ><em>汗管瘤</em></label>
                            <label><input type="checkbox" name="stains_cate"  {if condition="$sign == 3" } onclick="return false;" {/if} {if condition="in_array('扁平疣',$stains_cate)"} checked {/if} value="扁平疣" ><em>扁平疣</em></label>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="pifu_right">
                <img src="{$Think.const.IMG_URL}addinfo.jpg">
            </div>
        </div>

        <p style="clear: both;padding-top:10px;font-size: 16px">
            <span>1.黄褐斑</span>
            <span>2.真皮斑</span>
            <span>3.老年斑</span>
            <span>4.黑痣</span>
            <span>5.雀斑</span>
            <span>6.胎记</span>
            <span>7.痘印</span>
            <span>8.其他斑种</span>
        </p>
        <p>*有以上症状请如实告知以免影响祛斑效果*</p>
    </div>
    <div class="base_base if_did">
        <p>三、曾否做过皮肤护理：
            <label><input type="radio" name="if_huli"  {if condition="$sign == 3" } onclick="return false;" {/if} {if condition="$serinfo.done_skincare ==1"} checked {/if}  value="1">是</label>
            <label><input type="radio" name="if_huli"  {if condition="$sign == 3" } onclick="return false;" {/if} {if condition="$serinfo.done_skincare ==2"} checked {/if} value="2">否</label>
            <label><input type="radio" name="if_huli"  {if condition="$sign == 3" } onclick="return false;" {/if} {if condition="$serinfo.done_skincare ==3"} checked {/if} value="3">定期</label>
        </p>
        <p>面部是否微整：
            <label><input type="radio" name="if_surgery"  {if condition="$sign == 3" } onclick="return false;" {/if}  value="1" {if condition="$serinfo.micro_surgery ==1"} checked {/if} > 是</label>
            <label><input type="radio" name="if_surgery"  {if condition="$sign == 3" } onclick="return false;" {/if} value="2" {if condition="$serinfo.micro_surgery ==2"} checked {/if} >否</label>
        <div class="sur_detail"  {if condition="$serinfo.micro_surgery ==1 && !empty($serinfo.surgery_detail)" } style="display: block" {else/} style="display: none" {/if}>
            详情告知：<input style="width: 220px;" class="surgery_detail" type="text" name="surgery_detail" value="{if condition='!empty($serinfo.surgery_detail)' }{$serinfo.surgery_detail} {/if}" id="surgery_detail"  {if condition="$sign == 3" } readonly {/if}>
        </div>

        </p>
    </div>
    <div class="base_base solution">
        <p>四、祛斑方案：<input style="width: 250px" type="text" name="solution" class="ssolution" id="solution"  {if condition="$sign == 3" } readonly {/if} value="{$serinfo.solution}"></p>
        <p><em>配增产品：</em><input style="width: 250px" type="text" name="use_product" class="use_product" id="use_product"  {if condition="$sign == 3" } readonly {/if} value="{$serinfo.product}">
        </p>
    </div>

    <div class="base_base service_record">
        <p>服务记录</p>
        <ul>
            <li style="width: 15%;text-align: center;">日期</li>
            <li style="width: 18%;text-align: center;">服务项目</li>
            <li style="width: 25%;text-align: center;">当天服务内容</li>
            <li style="width: 13%;text-align: center;">技师签名</li>
            <li style="width: 20%;text-align: center;">产品</li>
             {if condition="$sign==1"} <li style="width: 8%;text-align: center;font-size: 18px">操作</li>{/if}
        </ul>
        {if condition="!empty($serdetail)"}
        {foreach $serdetail as $k}
        <ul >
            <li style="width: 15%;text-align: center;font-size: 16px">{$k.time}</li>
            <li style="width: 18%;text-align: center;overflow: hidden;font-size: 16px" onmouseover="show_all(this);">{$k.ser_demo}</li>
            <li style="width: 25%;text-align: center;overflow: hidden;font-size: 16px" onmouseover="show_all(this);" >{$k.ser_detail}</li>
            <li style="width: 13%;text-align: center;overflow: hidden;font-size: 16px"><img class="server_peo_ok"  width="80" height="36" src="{$k.ser_sign}" /></li>
            <li style="width: 20%;text-align: center;overflow: hidden;font-size: 16px" onmouseover="show_all(this);">{$k.ser_pro}</li>
            {if condition="$sign==1"} <li style="width: 8%;text-align: center;font-size: 16px"><span class="del_server" attrid="{$k.id}" onclick="del_ser(this)";>x</span></li>{/if}
        </ul>
        {/foreach}
        {/if}
        <ul class="info_sub">
            <li class="creat_time">{$create_time|date="Y-m-d",###}</li>
            <li class="server_demo"><input type="text" name="" onmouseover="this.title=this.value"></li>
            <li class="server_detail"><input type="text" name="" onmouseover="this.title=this.value"></li>
            <li class="server_sign"><img class="server_peo_ok" onclick="ser_peo_ok(this);" width="80" height="36"
                                         src=" "></li>
            <li class="server_pro"><input type="text" onmouseover="this.title=this.value"></li>
            <li class="cazuo"><span class="add_service" onclick="add_server(this);">+</span><span class="ok_service"
                                                                                                  onclick="confirm_server(this);">✔</span>
            </li>
        </ul>
        <script>
            function add_server(e) {
                var par = $(e).parent().parent().html();
                $(e).parent().parent().parent().children().last().after('<ul class="info_sub">' + par + '</ul>');
            }

            function show_all(e) {
                $(e).attr('title', $(e).text());
            }

            function confirm_server(e) {
                var time = $(e).parent().parent().find('.creat_time').text();
                var ser_demo = $(e).parent().parent().find('.server_demo input').val();
                var ser_detail = $(e).parent().parent().find('.server_detail input').val();
                var ser_sign = $(e).parent().parent().find('.server_sign img').attr('src');
                var ser_pro = $(e).parent().parent().find('.server_pro input').val();
                time = time.trim().replace(/\s/g, "");
                ser_demo = ser_demo.trim().replace(/\s/g, "");
                ser_detail = ser_detail.trim().replace(/\s/g, "");
                ser_sign = ser_sign.trim().replace(/\s/g, "");
                ser_pro = ser_pro.trim().replace(/\s/g, "");

                //服务项目
                var server_demo = $(e).parent().parent().find('.server_demo input').val().replace(/(^\s*)|(\s*$)/g, "");
                if(server_demo == 'null' ||  server_demo == undefined || server_demo == ""){
                    alert('服务项目不能为空！');
                    return false;
                }
                //服务内容
                var server_detail = $(e).parent().parent().find('.server_detail input').val().replace(/(^\s*)|(\s*$)/g, "");
                if(server_detail == 'null' ||  server_detail == undefined || server_detail == ""){
                    alert('服务内容不能为空！');
                    return false;
                }
                //技师签名
                var server_sign =  $(e).parent().parent().find('.server_sign img').attr('src').replace(/(^\s*)|(\s*$)/g, "");

                if(server_sign == 'null' ||  server_sign == undefined || server_sign == ""){
                    alert('技师签名不能为空！');
                    return false;
                }
                //产品
                var product = $(e).parent().parent().find('.server_pro input').val().replace(/(^\s*)|(\s*$)/g, "");
                if(product == 'null' ||  product == undefined || product == ""){
                    alert('产品不能为空！');
                    return false;
                }
                var if_input = $(e).parent().parent().parent().find('.info_sub').length;
                if (parseInt(if_input) > 1) {
                    $(e).parent().parent().remove();
                } else {
                    var ss = '<ul class="info_sub">\n' +
                        '            <li class="creat_time">{$create_time|date="Y-m-d",###}</li>\n' +
                        '            <li class="server_demo"><input type="text" name="" onmouseover="this.title=this.value"></li>\n' +
                        '            <li class="server_detail"><input type="text" name="" onmouseover="this.title=this.value"></li>\n' +
                        '            <li class="server_sign"><img class="server_peo_ok" onclick="ser_peo_ok(this);" width="80" height="36"\n' +
                        '                                         src=" "></li>\n' +
                        '            <li class="server_pro"><input type="text" onmouseover="this.title=this.value"></li>\n' +
                        '            <li class="cazuo"><span class="add_service" onclick="add_server(this);">+</span><span class="ok_service" onclick="confirm_server(this);">✔</span>\n' +
                        '            </li>\n' +
                        '        </ul>';
                    $(e).parent().parent().parent().children().last().after(ss);

                    $(e).parent().parent().remove();
                }
                var html = ' <ul class="confim_info">\n' +
                    '            <li class="time" style="width: 15%;text-align: center;font-size: 16px">' + time + '</li>\n' +
                    '            <li class="ser_demo" style="width: 18%;text-align: center;overflow: hidden;font-size: 16px" onmouseover="show_all(this);">' + ser_demo + '</li>\n' +
                    '            <li class="ser_detail" style="width: 25%;text-align: center;overflow: hidden;font-size: 16px" onmouseover="show_all(this);">' + ser_detail + '</li>\n' +
                    '            <li class="ser_sign" style="width: 13%;text-align: center;overflow: hidden;font-size: 16px" ><img class="server_peo_ok_conf" width="80" height="36"\n' +
                    '                                         src="' + ser_sign + ' "></li>\n' +
                    '            <li class="ser_pro" style="width: 20%;text-align: center;overflow: hidden;font-size: 16px" onmouseover="show_all(this);">' + ser_pro + '</li>\n' +
                    '            <li style="width: 8%;text-align: center;font-size: 16px"><span class="del_server" onclick="del_ser(this)";>x</span></li>\n' +
                    '        </ul>';
                $('.info_sub').eq(0).before(html);
            }

            function del_ser(e) {
                var id = parseInt($(e).attr('attrid'));
                if(id>0){
                    var msg = "您真的确定要删除吗？\n\n请确认！";
                    if (confirm(msg) == true) {
                        $.ajax({
                            url: '{$Think.const.DQURL}index/customers/delserverrecord',// 获取自己系统后台用户信息接口
                            data: {'rid':id},
                            type: "POST",
                            dataType: "json",
                            success: function (data) {
                                if (data) {
                                    var data = JSON.parse(data);
                                    if (data.code == "200") { //判断返回值，这里根据的业务内容可做调整
                                        $(e).parent().parent().remove();
                                    } else {
                                        alert(data.msg);
                                        $(e).removeAttr('disabled');
                                        return false;
                                    }
                                }
                            },
                            error: function (data) {
                                $(e).removeAttr('disabled');
                                console.log(data.message);
                            }
                        });
                    }else {
                        return false;
                    }
                }
                var if_input = $(e).parent().parent().parent().find('.info_sub').length;
                if (parseInt(if_input) > 0) {
                    $(e).parent().parent().remove();
                } else {
                    var ss = '<ul class="info_sub">\n' +
                        '            <li class="creat_time">{$create_time|date="Y-m-d",###}</li>\n' +
                        '            <li class="server_demo"><input type="text" name="" onmouseover="this.title=this.value"></li>\n' +
                        '            <li class="server_detail"><input type="text" name="" onmouseover="this.title=this.value"></li>\n' +
                        '            <li class="server_sign"><img class="server_peo_ok" onclick="ser_peo_ok(this);" width="80" height="36"\n' +
                        '                                         src=" "></li>\n' +
                        '            <li class="server_pro"><input type="text" onmouseover="this.title=this.value"></li>\n' +
                        '            <li class="cazuo"><span class="add_service" onclick="add_server(this);">+</span><span class="ok_service" onclick="confirm_server(this);">✔</span>\n' +
                        '            </li>\n' +
                        '        </ul>';
                    $(e).parent().parent().parent().children().last().after(ss);

                    $(e).parent().parent().remove();
                }
            }
        </script>
    </div>
    <div class="base_base sign" style="clear: both">
        <p class="customer_sign">
        <div class="customer_sign_start"><span>顾客确认：</span><img class="cus_sign_ok" width="80" height="50"
                                                                src="{$serinfo.customer_sign}">
        </div>
        </p>
        <p class="dean_sign">
        <div class="dean_sign_start"><span>院长确认：</span><img class=" {if condition='$sign == 3' } {else/} dean_sign_ok {/if}" width="80" height="50"
                                                            src=" ">

        </div>
        </p>

        <p><span><em>接待人：</em><input style="width: 150px" type="text" name="wz_detail" id="who_meet" readonly
                                     value="{$reception}"></span>
            <span><em>咨询日期：</em><input style="width: 150px" type="text" name="wz_detail" id="when"
                                       value="{$serinfo.ask_time}" readonly></span>
        </p>
        <p>
            <span style="position: relative"><em>分配技师：</em>
                <select style="width: 250px" class="search_select" {if condition='$sign == 3'} disabled   {else /}id="selectInput"{/if}" name="wz_detail" autocomplete="off">
                     {foreach $jsinfo as $k }
                    <option value="{$k.name}" dd="{$k.quanpin}" es="{$k.jianxie}" ss="{$k.id}" taxrate=""  {if condition="$serinfo.server_id ==$k.id" }  selected="selected" {/if}>{$k.name}</option>
                    {/foreach}
                </select>
                <input class="jsid" value="{$serinfo.server_id}" type="hidden">
                </span>
        </p>
        <p class="source_from">
            <em>途径：</em>
            <label>{$serinfo.source_from}</label>
        </p>
        <p class="submit_ok" onclick="confirm_sub(this);"><span>确认</span></p>
    </div>
</div>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdn.bootcss.com/layer/2.3/layer.js"></script>
<script>
    var fileList = [];
    $(function () {
        $('.choose').click(function(){
            $('#choose-file').click();
            $('.con_btn').css('display','');
        })
        ////////////////////////////////////////////////图片上传//////////////////////////////////////////////
        //声明变量
        var $button = $('#upload'),
            //选择文件按钮
            $file = $("#choose-file"),
            //回显的列表
            $list = $('.file-list');
            //选择要上传的所有文件

        //当前选择上传的文件
        var curFile;
        // 选择按钮change事件，实例化fileReader,调它的readAsDataURL并把原生File对象传给它，
        // 监听它的onload事件，load完读取的结果就在它的result属性里了。它是一个base64格式的，可直接赋值给一个img的src.
        $file.on('change', function (e) {
            //上传过图片后再次上传时限值数量
            var numold = $('.file-list li').length;
            if(numold >= 6){
                layer.alert('最多上传6张图片');
                return;
            }
            //限制单次批量上传的数量
            var num = e.target.files.length;
            var numall = numold + num;
            if(num >6 ){
                layer.alert('最多上传6张图片');
                return;
            }else if(numall > 6){
                layer.alert('最多上传6张图片');
                return;
            }
            //原生的文件对象，相当于$file.get(0).files;//files[0]为第一张图片的信息;
            curFile = this.files;
            // curFile = $file.get(0).files;
            // console.log(curFile);
            //将FileList对象变成数组
            fileList = fileList.concat(Array.from(curFile));
            // console.log(fileList);
            for (var i = 0, len = curFile.length; i < len; i++) {
                reviewFile(curFile[i])
            }
            $('.file-list').fadeIn(2500);
        })


        function reviewFile(file) {
            //实例化fileReader,
            var fd = new FileReader();
            //获取当前选择文件的类型
            var fileType = file.type;
            //调它的readAsDataURL并把原生File对象传给它，
            fd.readAsDataURL(file);//base64
            // console.log(file);
            //监听它的onload事件，load完读取的结果就在它的result属性里了
            fd.onload = function () {
                if (/^image\/[jpeg|png|jpg|gif]/.test(fileType)) {
                    $list.append('<li class="file-item"><img src="' + this.result + '" alt="" height="70"><span class="file-del"><i class="iconfont ">&#xe636;</i></span></li>').children(':last').hide().fadeIn(2500);
                } else {
                    $list.append('<li class="file-item"><span class="file-name">' + file.name + '</span><span class="file-del"><i class="iconfont ">&#xe636;</i></span></li>')
                }
            }
        }

        //点击删除按钮事件：
        $(".file-list").on('click', '.file-del', function () {
            let $parent = $(this).parent();
            console.log($parent);
            let index = $parent.index();
            fileList.splice(index, 1);
            $parent.fadeOut(850, function () {
                $parent.remove()
            });
            var filess = document.getElementById('choose-file');
            filess.value = '';
        });
        //点击上传按钮事件：
        $button.on('click', function () {
            if(fileList.length > 6){
                layer.alert('最多允许上传6张图片');
                return;
            } else {
                var formData = new FormData();
                for (var i = 0, len = fileList.length; i < len; i++) {
                    //console.log(fileList[i]);
                    formData.append('upfile[]', fileList[i]);
                }
                formData.append('name', name);
                $.ajax({
                    url: '{$Think.const.DQURL}index/customers/imgtest?serverno={$serid}',
                    type: 'post',
                    data: formData,
                    dataType: 'json',
                    processData: false,
                    contentType: false,
                    success: function (data) {
                        var data = JSON.parse(data);
                        if (data.code == 200) {
                           console.log(data);return false;
                        } else {
                            layer.msg(data.msg);
                        }
                    }
                })
            }
        })
    })


</script>
<script>
    function ser_peo_ok(e) {
        $(e).addClass('select_ser');
        console.log($(e).attr('class'));
        layer.open({
            type: 2,
            title: '签名',
            maxmin: true,
            area: ['500px', '400px'],
            content: '{$Think.const.SITEURL}/template/sign.html?sign=service'
        });

    }

    function if_show(e) {
        var attrval = parseInt($(e).val());
        // console.log(attrval);
        if (attrval == 1) {
            $('.sur_detail').css('display','block');
            // $(e).parent().parent().find('.surgery_detail').removeAttr('disabled');
        } else if (attrval == 2) {
            $('.sur_detail').css('display','none');
            // $(e).parent().parent().find('.surgery_detail').attr('disabled', 'disabled');
        }
    }

    $('.customer_sign_start .cus_sign_ok').on('click', function () {
        layer.open({
            type: 2,
            title: '签名',
            maxmin: true,
            area: ['500px', '400px'],
            content: '{$Think.const.SITEURL}/template/sign.html?sign=cus'
        });
    });
    $('.dean_sign_start .dean_sign_ok').on('click', function () {
        layer.open({
            type: 2,
            title: '签名',
            maxmin: true,
            area: ['500px', '400px'],
            content: '{$Think.const.SITEURL}/template/sign.html?sign=dean'
        });
    });


    function confirm_sub(e) {
        $(e).attr('disabled','disabled');
        var customers = '';
        var addinfo = '';
        var cussrc ='';
        cussrc = $('#view').css("background-image").split("\"")[1];
        var serid = parseInt($('.mbs_no').attr('attrid'));
        //
        var server_no = $('.mbs_no span').text().replace(/(^\s*)|(\s*$)/g, "");
        //客户信息延伸
        var customer_id = parseInt($('.mbs_no').attr('attruid'));
        var cus_job = $('#user_job').val().replace(/(^\s*)|(\s*$)/g, "");
        var is_marry = parseInt($('input[name="is_marry"]:checked').val());
        var if_huli = parseInt($('input[name="if_huli"]:checked').val());
        //是否微整
        var if_surgery = parseInt($('input[name="if_surgery"]:checked').val());
        //详情告知
        var sur_deyail = $('.surgery_detail').val().replace(/(^\s*)|(\s*$)/g, "");
        var solution = $('.ssolution').val().replace(/(^\s*)|(\s*$)/g, "");
        var use_product = $('.use_product').val().replace(/(^\s*)|(\s*$)/g, "");
        var customer_sign = $('.cus_sign_ok').attr('src').replace(/(^\s*)|(\s*$)/g, "");
        var dean_sign = $('.dean_sign_ok').attr('src').replace(/(^\s*)|(\s*$)/g, "");
        if(!customer_sign.length>1){
            //alert('顾客签字不能为空！');
           // $(e).removeAttr('disabled');
           // return false;
        }
        //技师名称
        var jishi = $('#selectInputClone').val();
            if(jishi!='' && jishi!=null && jishi!=undefined){
                jishi = jishi.replace(/(^\s*)|(\s*$)/g, "");
            }else{
                jishi = $('.search_select').val();
            }

        //技师id
        var jsid = parseInt($('.selectssss').val());
            if(!jsid>0){
                jsid = parseInt($('.jsid').val());
            }
        if(customer_id>0){
            customers =  'customer_id*' + customer_id + ',';
        }else{
            alert('无效的客户信息！');
            $(e).removeAttr('disabled');
            return false;
        }

        if(jishi.length>1 && !jsid>0){

        }else{
            if(jishi != null && jishi != undefined && jishi != ""){
                customers = customers + 'server_name*'+jishi+',';
            }
            if(jsid>0){
                customers = customers + 'server_id*'+jsid+',';
            }else{
                alert('请分配技师！');
                $(e).removeAttr('disabled');
                return false;
            }
        }

        if(server_no != null && server_no != undefined && server_no != ""){
            customers = customers + 'server_no*'+server_no+','
        }else{
           // alert('无效的单子！');
            //$(e).removeAttr('disabled');
           // return false;
        }

        if(is_marry>0){
            addinfo =  'cusismarry*' + is_marry + ',';
        }else{
            //alert('请勾选是否已婚！');
          //  $(e).removeAttr('disabled');
          //  return false;
        }
        if(cus_job != null && cus_job != undefined && cus_job != ""){
            addinfo = addinfo + 'cusjob*'+cus_job+','
        }
        if(if_surgery>0){
            customers =  customers + 'micro_surgery*' + if_surgery + ',';
            if(if_surgery==1 && sur_deyail != null && sur_deyail != undefined && sur_deyail != ''){
                customers = customers + 'surgery_detail*'+sur_deyail+',';
            }
        }else{
            //alert('请勾选是否微整！');
           // $(e).removeAttr('disabled');
          //  return false;
        }

        if(if_huli>0){
            customers =  customers + 'done_skincare*' + if_huli + ','
        }else{
          //  /alert('请勾选护理信息！');
           // $(e).removeAttr('disabled');
           // return falsep;
        }

        if(solution != null && solution != undefined && solution != ""){
            customers = customers + 'solution*'+solution+','
        }else{
          //  alert('请填写解决方案');
          //  $(e).removeAttr('disabled');
          //  return  false;
        }
        if(use_product != null && use_product != undefined && use_product != ""){
            customers = customers + 'product*'+use_product+','
        }else{
           // alert('请填写产品');
           // $(e).removeAttr('disabled');
          //  return false;
        }
        //客户状态评测信息
        var check_skin_cate = '';//皮肤类型
        var check_health = '';//身体状况 health_info
        var check_freckle_experience = '';//祛斑经历 freckle_experience
        var check_stains_cate = '';//色斑类型 stains_cate

        //皮肤类型
        $("input[name='skin_cate']:checked").each(function (i) {
            var my_val = $(this).val();
            if (my_val == null || my_val == undefined || my_val == "") {
               // $(e).removeAttr('disabled');
               // alert('你未选择皮肤类型，请选择！')
              //  return false;
            } else {
                if (check_skin_cate.length > 0) {
                    check_skin_cate = check_skin_cate + ',' + my_val;
                } else {
                    check_skin_cate = my_val;
                }
            }
        });
        //身体状况
        $("input[name='health_info']:checked").each(function (i) {
            var health_val = $(this).val();
            if (health_val == null || health_val == undefined || health_val == "") {
               // alert('你未选择身体状况，请选择！')
               // $(e).removeAttr('disabled');
               // return false;
            } else {
                if (check_health.length > 0) {
                    check_health = check_health + ',' + health_val;
                } else {
                    check_health = health_val;
                }
            }
        });
        //祛斑经历
        $("input[name='freckle_experience']:checked").each(function (i) {
            var freckle_val = $(this).val();
            if (freckle_val == null || freckle_val == undefined || freckle_val == "") {
              //  alert('你未选择祛斑经历，请选择！')
              //  $(e).removeAttr('disabled');
              //  return false;
            } else {
                if (check_freckle_experience.length > 0) {
                    check_freckle_experience = check_freckle_experience + ',' + freckle_val;
                } else {
                    check_freckle_experience = freckle_val;
                }
            }
        });
        //色斑类型
        $("input[name='stains_cate']:checked").each(function (i) {
            var stains_val = $(this).val();
            if (stains_val == null || stains_val == undefined || stains_val == "") {
             //   alert('你未选择色斑类型，请选择！')
              //  $(e).removeAttr('disabled');
              //  return false;
            } else {
                if (check_stains_cate.length > 0) {
                    check_stains_cate = check_stains_cate + ',' + stains_val;
                } else {
                    check_stains_cate = stains_val;
                }
            }
        });

        //服务添加
        var sserinfo = new Array();
        $(".confim_info").each(function(i){
            var serinfo = new Object();//放外层，（地址）赋值会被覆盖
            $(".confim_info").eq(i).find('li').each(function(j){
                var temp=$(".confim_info").eq(i).find('li').eq(j);
                var lival = temp.text();
                if(temp.attr('class') != 'null' &&  temp.attr('class') != undefined && temp.attr('class') != ""){
                    if(temp.attr('class') == 'ser_sign'){
                        var cname = temp.attr('class');
                        serinfo[cname] = temp.find('img').attr('src');
                        sserinfo[i] =  serinfo;
                    }else{
                        var cname = temp.attr('class');
                        serinfo[cname] = lival;
                        sserinfo[i] =  serinfo;
                    }
                }
            });
        });
        sserinfo = JSON.stringify(sserinfo);
        var formData = new FormData();
        if(fileList.length > 6){
            layer.alert('最多允许上传6张图片');
            $(e).removeAttr('disabled');
            return;
        } else {
            for (var i = 0, len = fileList.length; i < len; i++) {
                // console.log(fileList[i]);
                formData.append('upfile[]', fileList[i]);
            }
        }
            formData.append('name', name);
            formData.append('serid', serid);
            formData.append('customers', customers);
            formData.append('customer_sign', customer_sign);
            formData.append('cussrc', cussrc);
            formData.append('dean_sign', dean_sign);
            formData.append('sserinfo', sserinfo);
            formData.append('skin_cate', check_skin_cate);
            formData.append('health', check_health);
            formData.append('freckle_experience', check_freckle_experience);
            formData.append('stains_cate', check_stains_cate);
            formData.append('addinfos', addinfo);
        $.ajax({
            url: '{$Think.const.DQURL}index/customers/save_server',// 获取自己系统后台用户信息接口
            type: 'post',
            data: formData,
            dataType: 'json',
            processData: false,
            contentType: false,
            success: function (data) {
                if (data) {
                    var data = JSON.parse(data);
                    if (data.code == "200") { //判断返回值，这里根据的业务内容可做调整
                        $(e).removeAttr('disabled');
                        alert(data.msg);
                        // close_open();
                        window.location.reload();
                    } else {
                        alert(data.msg);
                        $(e).removeAttr('disabled');
                        return false;
                    }
                }
            },
            error: function (data) {
                $(e).removeAttr('disabled');
                console.log(data.message);
            }
        });
        return false;
    }
    function close_open() {
        var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
        parent.layer.close(index);
    }
    function isNullObj(obj){
        for(var i in obj){
            if(obj.hasOwnProperty(i)){
                return false;
            }
        }
        return true;
    }
</script>
<script type="text/javascript">
    //上传封面
    //document.addEventListener('touchmove', function (e) { e.preventDefault(); }, false);
    var clipArea = new bjj.PhotoClip("#clipArea", {
        size: [350, 362],// 截取框的宽和高组成的数组。默认值为[260,260]
        outputSize: [350, 362], // 输出图像的宽和高组成的数组。默认值为[0,0]，表示输出图像原始大小
        //outputType: "jpg", // 指定输出图片的类型，可选 "jpg" 和 "png" 两种种类型，默认为 "jpg"
        file: "#file", // 上传图片的<input type="file">控件的选择器或者DOM对象
        view: "#view", // 显示截取后图像的容器的选择器或者DOM对象
        ok: "#clipBtn", // 确认截图按钮的选择器或者DOM对象
        loadStart: function () {
            // 开始加载的回调函数。this指向 fileReader 对象，并将正在加载的 file 对象作为参数传入
            $('.cover-wrap').fadeIn();
            console.log("照片读取中");
        },
        loadComplete: function () {
            // 加载完成的回调函数。this指向图片对象，并将图片地址作为参数传入
            console.log("照片读取完成");
        },
        //loadError: function(event) {}, // 加载失败的回调函数。this指向 fileReader 对象，并将错误事件的 event 对象作为参数传入
        clipFinish: function (dataURL) {
            // 裁剪完成的回调函数。this指向图片对象，会将裁剪出的图像数据DataURL作为参数传入
            $('.cover-wrap').fadeOut();
            $('#view').css('background-size', '100% 100%');
            $('.cece_2').css('background-image','');
            console.log(dataURL);
        }
    });
    //clipArea.destroy();

</script>
<script src="{$Think.const.JS_URL}searchSelectNew.js"></script>
{include file="template/footer.html"}
</body>
</html>